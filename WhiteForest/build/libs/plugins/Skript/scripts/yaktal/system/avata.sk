# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🧠 메타버스 아바타 시스템 - Citizen 인벤토리 저장/복원 로직 ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
#
# 📌 기능 요약:
# - 플레이어가 서버를 나가면 해당 위치에 Citizen NPC를 생성하고 인벤토리 및 장비를 저장함
# - 다시 접속하면 Citizen을 제거하고 저장된 인벤토리를 복원함
# - NPC를 클릭하면 해당 플레이어의 인벤토리를 GUI로 열 수 있음
# - GUI에서 인벤토리를 수정하면 Citizen의 장비도 실시간으로 반영됨
#
# 📦 주요 변수 구조:
# - {quit::%uuid%::cid} → 플레이어의 Citizen ID
# - {quit::npc::%cid%::uuid} → Citizen ID로 플레이어 UUID 역참조
# - {quit::%uuid%::inv::*} → 인벤토리 슬롯 및 장비 저장
# - {open::%uuid%::opuuid} → 현재 인벤토리를 열고 있는 대상 UUID
# - {opened::%uuid%::op} → 인벤토리 열림 상태 확인
#
# 🛠️ 주요 이벤트:
# - on quit → Citizen 생성 및 인벤토리 저장
# - on join → Citizen 제거 및 인벤토리 복원
# - on npc right click → GUI 인벤토리 열기
# - on inventory closing → 인벤토리 저장 및 Citizen 장비 업데이트
# - on inventory click → barrier 클릭 방지
#
# ✨ 확장 가능 아이디어:
# - Citizen이 플레이어처럼 움직이게 하기
# - 인벤토리 변경 로그 저장
# - Citizen 위에 플레이어 이름 및 접속 시간 표시
#
# 작성자: 상현 😎
# 작성일: 2025-08-26



on join:
    if {quit::%uuid of player%::cid} is set:
        remove citizen {quit::%uuid of player%::cid}
        delete {quit::%uuid of player%::cid}
        
        if {opened::%uuid of player%::op} is set:
            close {openingplayer::%uuid of player%::player}'s inventory
            wait 10 tick
            loop 36 times:
                set {_loop-number} to loop-number - 1
                set slot {_loop-number} of player to {quit::%uuid of player%::inv::%{_loop-number}%}
            set player's helmet to {quit::%uuid of player%::inv::helmet}
            set player's chestplate to {quit::%uuid of player%::inv::chestplate}
            set player's leggings to {quit::%uuid of player%::inv::leggings}
            set player's boots to {quit::%uuid of player%::inv::boots}
            set player's offhand item to {quit::%uuid of player%::inv::offhand}
            delete {quit::%uuid of player%::inv::*}
            set {quit::%uuid of player%::inv::change} to false

        if {opened::%uuid of player%::op} is not set:
            if {quit::%uuid of player%::inv::change} is true:
                loop 36 times:
                    set {_loop-number} to loop-number - 1
                    set slot {_loop-number} of player to {quit::%uuid of player%::inv::%{_loop-number}%}
                set player's helmet to {quit::%uuid of player%::inv::helmet}
                set player's chestplate to {quit::%uuid of player%::inv::chestplate}
                set player's leggings to {quit::%uuid of player%::inv::leggings}
                set player's boots to {quit::%uuid of player%::inv::boots}
                set player's offhand item to {quit::%uuid of player%::inv::offhand}
                delete {quit::%uuid of player%::inv::*}
                set {quit::%{open::%uuid of player%::opuuid}%::inv::change} to false
                        

    
    #cid 있으면 메타버스 케릭터 제거

on quit:
    create a citizen named "%player%" at location of player
    set {quit::%uuid of player%::cid} to last created citizen id
    set citizen {quit::%uuid of player%::cid}'s gravity to off
    set {_cid} to {quit::%uuid of player%::cid}
    set {quit::npc::%{_cid}%::uuid} to uuid of player 
    # quit/uuid/cid 에 citizen id 저장
    # quit/npc/%cid%/uuid 에 플레이어 uuid 저장
    change citizen {quit::%uuid of player%::cid} skin to "%player%"
    #스킨 변경
    #메타버스 케릭터 생성
    
    loop 36 times:
    #시@발 왜 1부터 시작함???? 일단 임시로 -1 붙여서 저장함
        set {_loop-number} to loop-number - 1
        set {quit::%uuid of player%::inv::%{_loop-number}%} to slot {_loop-number} of player 
    #quit/uuid/inv/0~35 에 인벤토리 저장

    set {_helmet} to player's helmet
    set {_chestplate} to player's chestplate
    set {_leggings} to player's leggings
    set {_boots} to player's boots

    set {quit::%uuid of player%::inv::helmet} to {_helmet}
    set {quit::%uuid of player%::inv::chestplate} to {_chestplate}
    set {quit::%uuid of player%::inv::leggings} to {_leggings}
    set {quit::%uuid of player%::inv::boots} to {_boots}
    #quit/uuid/inv/helmet 등등에 갑옷 저장

    set {quit::%uuid of player%::inv::offhand} to player's offhand item

    set {quit::%uuid of player%::inv::empty} to false

    equip citizen {quit::%uuid of player%::cid} with player's helmet
    equip citizen {quit::%uuid of player%::cid} with player's chestplate
    equip citizen {quit::%uuid of player%::cid} with player's leggings
    equip citizen {quit::%uuid of player%::cid} with player's boots
    set citizen {quit::%uuid of player%::cid}'s tool to player's tool
    set citizen {quit::%uuid of player%::cid}'s offhand item to player's offhand
    #플레이어의 갑옷을 케릭터에 넣음

    
    
    set {_citizen::uuid} to uuid of {quit::%uuid of player%::cid}
    #npc 클릭시 npc id 와 npc uuid 가져옴

on npc right click:
    set {_cid} to event-number
    set {uuid of player::op} to {_cid}
    set {_uuid} to {quit::npc::%{_cid}%::uuid}
    set {openingplayer::%{_uuid}%::player} to player
    if {opened::%{_uuid}%::op} is set:
        send "&c이미 다른 플레이어가 이 인벤토리를 열고있습니다!" to player
        stop
    if {quit::npc::%{_cid}%::uuid} is set:
        set {_uuid} to {quit::npc::%{_cid}%::uuid}
        set {open::%uuid of player%::opuuid} to {_uuid}
        set {opened::%{_uuid}%::op} to uuid of player

        #_uuid = npc 클릭시 플레이어 uuid

        set {_player} to ({_uuid} parsed as offline player)
        #npc 클릭시 누구 아바타인지 알려줌
        #npc 클릭시 npc 아이디를 통해 플레이어의 아바타를 확인할 수 있음

        if {quit::%{_uuid}%::inv::empty} is true:
            send "&c%name of {_player}% does not have a saved inventory." to player
            stop

        # 5행 체스트 생성
        set {inv::%{_uuid}%} to a new chest inventory with 6 rows named "&f&e%name of {_player}%'s Inventory"

        # 일반 슬롯 0~35 복원
        loop 36 times:
            set {_loop-number} to loop-number - 1


            if {_loop-number} is between 0 and 8:
                set {_slot::num} to {_loop-number} + 45
                set slot {_slot::num} of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::%{_loop-number}%}

            if {_loop-number} is between 9 and 35:
                set {_slot::num} to {_loop-number} + 9
                set slot {_slot::num} of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::%{_loop-number}%}

        loop 9 times:
            set {_slot} to loop-number + 9 - 1
            set slot {_slot} of {inv::%{_uuid}%} to barrier named " " with custom model data 1
        loop 4 times:
            set {_slot} to loop-number + 4 - 1
            set slot {_slot} of {inv::%{_uuid}%} to barrier named " " with custom model data 1


        # 갑바 및 오프핸드 표시용 슬롯
        set slot 0 of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::helmet}
        set slot 1 of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::chestplate}
        set slot 2 of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::leggings}
        set slot 3 of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::boots}
        set slot 8 of {inv::%{_uuid}%} to {quit::%{_uuid}%::inv::offhand}

        # 체스트 열기
        open {inv::%{_uuid}%} to player 

on inventory close:
    if {open::%uuid of player%::opuuid} is set:
        loop 54 times:

            set {_loop-number} to loop-number - 1
            
            if {_loop-number} is between 0 and 17:
                if {_loop-number} is 0:
                    set {quit::%{open::%uuid of player%::opuuid}%::inv::helmet} to slot {_loop-Number} of event-inventory
                if {_loop-number} is 1:
                    set {quit::%{open::%uuid of player%::opuuid}%::inv::chestplate} to slot {_loop-Number} of event-inventory
                if {_loop-number} is 2:
                    set {quit::%{open::%uuid of player%::opuuid}%::inv::leggings} to slot {_loop-Number} of event-inventory
                if {_loop-number} is 3:
                    set {quit::%{open::%uuid of player%::opuuid}%::inv::boots} to slot {_loop-Number} of event-inventory
                if {_loop-number} is 8:
                    set {quit::%{open::%uuid of player%::opuuid}%::inv::offhand} to slot {_loop-Number} of event-inventory
                
            if {_loop-number} is between 18 and 44:
                set {_slot} to {_loop-number} - 9
                set {quit::%{open::%uuid of player%::opuuid}%::inv::%{_slot}%} to slot {_loop-Number} of event-inventory


            if {_loop-number} is between 45 and 53:
                set {_slot} to {_loop-number} - 45 
                set {quit::%{open::%uuid of player%::opuuid}%::inv::%{_slot}%} to slot {_loop-Number} of event-inventory
        
        set {quit::%{open::%uuid of player%::opuuid}%::inv::change} to true

        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s helmet to {quit::%{open::%uuid of player%::opuuid}%::inv::helmet}
        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s chestplate to {quit::%{open::%uuid of player%::opuuid}%::inv::chestplate}
        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s leggings to {quit::%{open::%uuid of player%::opuuid}%::inv::leggings}
        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s boots to {quit::%{open::%uuid of player%::opuuid}%::inv::boots}
        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s tool to {quit::%{open::%uuid of player%::opuuid}%::inv::0}
        set citizen {quit::%{open::%uuid of player%::opuuid}%::cid}'s offhand item to {quit::%{open::%uuid of player%::opuuid}%::inv::offhand}

        delete {open::%uuid of player%::opuuid}
        set {_opuuid} to {quit::npc::%{uuid of player::op}%::uuid}
        delete {opened::%{_opuuid}%::op}

on inventory click:
    if event-item is barrier:
        cancel event

